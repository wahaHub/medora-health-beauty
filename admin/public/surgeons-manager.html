<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Surgeons Manager - Medora Admin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #333;
      padding: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    .header h1 { font-size: 24px; color: #333; }
    .header a { color: #667eea; text-decoration: none; }

    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #667eea;
      color: white;
      font-weight: 500;
    }
    tr:hover { background: #f9f9f9; }

    .surgeon-name {
      font-weight: 600;
      color: #333;
    }
    .surgeon-title {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .image-cell {
      width: 150px;
    }
    .image-slot {
      width: 120px;
      height: 80px;
      background: #f0f0f0;
      border: 2px dashed #ccc;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .image-slot:hover { border-color: #667eea; background: #f5f7ff; }
    .image-slot.has-image { border-style: solid; border-color: #4CAF50; }
    .image-slot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
    }
    .image-slot .placeholder {
      font-size: 24px;
      color: #ccc;
    }
    .image-slot .delete-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 20px;
      height: 20px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      font-size: 12px;
    }
    .image-slot:hover .delete-btn { display: block; }

    .loading {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f0f0f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background: #4CAF50;
      color: white;
      border-radius: 6px;
      z-index: 2000;
    }
    .notification.error { background: #f44336; }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Surgeons Photo Manager</h1>
    <a href="/admin/dashboard-new.html">‚Üê Back to Dashboard</a>
  </div>

  <table>
    <thead>
      <tr>
        <th>Surgeon</th>
        <th class="image-cell">Hero Photo</th>
        <th class="image-cell">Certification</th>
        <th class="image-cell">With Patients</th>
      </tr>
    </thead>
    <tbody id="surgeonsList">
      <tr><td colspan="4" style="text-align:center;padding:40px;">Loading surgeons...</td></tr>
    </tbody>
  </table>

  <div class="loading hidden" id="loading">
    <div class="spinner"></div>
  </div>

  <input type="file" id="fileInput" class="hidden" accept="image/*">

  <script type="module">
    import { getAllSurgeons } from './surgeons-data.js';

    let surgeons = [];
    let currentUpload = null;

    // Ëé∑ÂèñËÆ§ËØÅ headersÔºàÁî®‰∫é Vercel Áîü‰∫ßÁéØÂ¢ÉÔºâ
    function getAuthHeaders() {
      const token = localStorage.getItem('admin_token');
      const headers = { 'Content-Type': 'application/json' };
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      return headers;
    }

    document.addEventListener('DOMContentLoaded', loadSurgeons);

    document.getElementById('fileInput').addEventListener('change', async (e) => {
      if (e.target.files.length > 0 && currentUpload) {
        await uploadImage(e.target.files[0], currentUpload.surgeonId, currentUpload.slot);
        e.target.value = '';
        currentUpload = null;
      }
    });

    async function loadSurgeons() {
      try {
        console.log('üîç Loading surgeons from static data');
        surgeons = getAllSurgeons();
        console.log('‚úÖ Loaded surgeons:', surgeons.length);
        renderTable();

        // Â∞ùËØï‰ªéÊï∞ÊçÆÂ∫ìËé∑Âèñ images Êï∞ÊçÆÂπ∂ÂêàÂπ∂
        try {
          console.log('üîç Fetching images from database...');
          const token = localStorage.getItem('admin_token');
          console.log('üîë Token exists:', !!token);
          console.log('üîë Token preview:', token ? token.substring(0, 20) + '...' : 'null');

          const headers = {};
          if (token) {
            headers['Authorization'] = `Bearer ${token}`;
          }
          console.log('üì§ Request headers:', JSON.stringify(headers));

          console.log('üì° Fetching: /admin/api/surgeons-full');
          const res = await fetch('/admin/api/surgeons-full', { headers });
          console.log('üì° Response status:', res.status);
          console.log('üì° Response ok:', res.ok);
          console.log('üì° Response headers:', Object.fromEntries(res.headers.entries()));

          if (res.ok) {
            const data = await res.json();
            console.log('üì¶ Response data:', data);
            if (data.success && data.surgeons) {
              console.log('‚úÖ Loaded images from database:', data.surgeons.length);
              console.log('üì∏ Sample surgeon with images:', data.surgeons.find(s => s.images && Object.keys(s.images).length > 0));

              // Â∞ÜÊï∞ÊçÆÂ∫ìÁöÑ images Â≠óÊÆµÂêàÂπ∂Âà∞ÈùôÊÄÅÊï∞ÊçÆ‰∏≠
              surgeons = surgeons.map(s => {
                const dbSurgeon = data.surgeons.find(db => db.surgeon_id === s.surgeon_id);
                if (dbSurgeon && dbSurgeon.images) {
                  return { ...s, images: dbSurgeon.images };
                }
                return s;
              });
              console.log('‚úÖ Merged surgeons:', surgeons.length);
              renderTable();
            } else {
              console.error('‚ùå Invalid response structure:', data);
            }
          } else {
            const errorText = await res.text();
            console.error('‚ùå HTTP Error:', res.status, res.statusText);
            console.error('‚ùå Error body:', errorText);
          }
        } catch (err) {
          console.error('‚ùå Fetch error:', err);
          console.error('‚ùå Error stack:', err.stack);
        }
      } catch (err) {
        console.error('‚ùå Load surgeons error:', err);
        console.error('‚ùå Error stack:', err.stack);
        showNotification('Error loading surgeons: ' + err.message, true);
      }
    }

    function renderTable() {
      const tbody = document.getElementById('surgeonsList');
      tbody.innerHTML = surgeons.map(s => {
        const images = s.images || {};
        return `
          <tr>
            <td>
              <div class="surgeon-name">${s.name}</div>
              <div class="surgeon-title">${s.title || ''}</div>
            </td>
            <td class="image-cell">${renderSlot(s.surgeon_id, 'hero', images.hero)}</td>
            <td class="image-cell">${renderSlot(s.surgeon_id, 'certification', images.certification)}</td>
            <td class="image-cell">${renderSlot(s.surgeon_id, 'with_patients', images.with_patients)}</td>
          </tr>
        `;
      }).join('');
    }

    function renderSlot(surgeonId, slot, url) {
      if (url) {
        return `
          <div class="image-slot has-image" onclick="triggerUpload('${surgeonId}', '${slot}')">
            <img src="${url}" alt="${slot}">
            <button class="delete-btn" onclick="event.stopPropagation(); deleteImage('${surgeonId}', '${slot}')">√ó</button>
          </div>
        `;
      }
      return `
        <div class="image-slot" onclick="triggerUpload('${surgeonId}', '${slot}')">
          <span class="placeholder">+</span>
        </div>
      `;
    }

    // Êö¥Èú≤ÂáΩÊï∞Âà∞ÂÖ®Â±Ä‰ΩúÁî®ÂüüÔºå‰æõ onclick ‰ΩøÁî®
    window.triggerUpload = function(surgeonId, slot) {
      currentUpload = { surgeonId, slot };
      document.getElementById('fileInput').click();
    };

    window.deleteImage = async function(surgeonId, slot) {
      if (!confirm('Delete this image?')) return;
      showLoading(true);
      try {
        console.log('üóëÔ∏è Deleting image:', { surgeonId, slot });
        const token = localStorage.getItem('admin_token');
        console.log('üîë Token exists:', !!token);

        const headers = {};
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }

        const key = `surgeons/${surgeonId}/${slot}.jpg`;
        console.log('üóëÔ∏è Delete key:', key);
        console.log('üì° DELETE: /admin/api/images/' + encodeURIComponent(key));

        // Âà†Èô§ R2 ‰∏äÁöÑÂõæÁâá
        const deleteRes = await fetch(`/admin/api/images/${encodeURIComponent(key)}`, {
          method: 'DELETE',
          headers
        });
        console.log('üì° Delete response status:', deleteRes.status);
        const deleteData = await deleteRes.json().catch(() => ({ error: 'Could not parse JSON' }));
        console.log('üì° Delete response:', deleteData);

        // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
        console.log('üì° POST: /admin/api/update-surgeon-image');
        console.log('üì§ Update body:', { surgeonId, slot, imageUrl: null });
        const updateRes = await fetch('/admin/api/update-surgeon-image', {
          method: 'POST',
          headers: { ...getAuthHeaders() },
          body: JSON.stringify({ surgeonId, slot, imageUrl: null })
        });
        console.log('üì° Update response status:', updateRes.status);
        const updateData = await updateRes.json().catch(() => ({ error: 'Could not parse JSON' }));
        console.log('üì° Update response:', updateData);

        if (deleteRes.ok && updateRes.ok) {
          showNotification('Deleted!');
          loadSurgeons();
        } else {
          console.error('‚ùå Delete failed:', { deleteRes: deleteRes.status, updateRes: updateRes.status });
          showNotification('Delete failed', true);
        }
      } catch (err) {
        console.error('‚ùå Delete error:', err);
        console.error('‚ùå Error stack:', err.stack);
        showNotification('Error: ' + err.message, true);
      }
      showLoading(false);
    };

    async function uploadImage(file, surgeonId, slot) {
      showLoading(true);
      try {
        console.log('üì§ Uploading image:', { surgeonId, slot, fileName: file.name, fileSize: file.size });
        const token = localStorage.getItem('admin_token');
        console.log('üîë Token exists:', !!token);

        const uploadHeaders = {};
        if (token) {
          uploadHeaders['Authorization'] = `Bearer ${token}`;
        }
        console.log('üì§ Upload headers:', JSON.stringify(uploadHeaders));

        const formData = new FormData();
        formData.append('file', file);
        formData.append('path', `surgeons/${surgeonId}`);
        formData.append('filename', `${slot}.jpg`);
        console.log('üì¶ FormData prepared:', {
          path: `surgeons/${surgeonId}`,
          filename: `${slot}.jpg`
        });

        console.log('üì° POST: /admin/api/upload');
        const res = await fetch('/admin/api/upload', {
          method: 'POST',
          headers: uploadHeaders,
          body: formData
        });
        console.log('üì° Upload response status:', res.status);
        const data = await res.json().catch(() => ({ error: 'Could not parse JSON' }));
        console.log('üì° Upload response:', data);

        if (data.success) {
          console.log('‚úÖ Upload successful, URL:', data.url);
          console.log('üì° POST: /admin/api/update-surgeon-image');
          console.log('üì§ Update body:', { surgeonId, slot, imageUrl: data.url });

          const updateRes = await fetch('/admin/api/update-surgeon-image', {
            method: 'POST',
            headers: { ...getAuthHeaders() },
            body: JSON.stringify({ surgeonId, slot, imageUrl: data.url })
          });
          console.log('üì° Update response status:', updateRes.status);
          const updateData = await updateRes.json().catch(() => ({ error: 'Could not parse JSON' }));
          console.log('üì° Update response:', updateData);

          if (updateRes.ok) {
            showNotification('Uploaded!');
            loadSurgeons();
          } else {
            console.error('‚ùå Update failed:', updateRes.status);
            showNotification('Upload succeeded but database update failed', true);
          }
        } else {
          console.error('‚ùå Upload failed:', data);
          showNotification('Upload failed: ' + (data.message || 'Unknown error'), true);
        }
      } catch (err) {
        console.error('‚ùå Upload error:', err);
        console.error('‚ùå Error stack:', err.stack);
        showNotification('Error: ' + err.message, true);
      }
      showLoading(false);
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('hidden', !show);
    }

    function showNotification(msg, isError) {
      const div = document.createElement('div');
      div.className = 'notification' + (isError ? ' error' : '');
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 2000);
    }
  </script>
</body>
</html>
