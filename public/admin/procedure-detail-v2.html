<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Procedure Images - Medora Admin</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      color: #333;
      padding: 20px;
    }

    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .procedure-title {
      font-size: 28px;
      font-weight: 600;
      color: #667eea;
    }

    .procedure-path {
      font-size: 13px;
      color: #999;
      font-family: monospace;
      margin-top: 5px;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      text-decoration: none;
      transition: background 0.2s;
    }

    .back-btn:hover {
      background: #5568d3;
    }

    /* Section */
    .section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 25px;
      margin-bottom: 25px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-description {
      font-size: 13px;
      color: #666;
      margin-bottom: 20px;
    }

    /* Hero Section - Single Image */
    .hero-slot {
      width: 100%;
      max-width: 800px;
      aspect-ratio: 16/9;
      border: 2px dashed #e0e0e0;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      background: #fafafa;
    }

    .hero-slot:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .hero-slot.has-image {
      border-style: solid;
      border-color: #4caf50;
      padding: 0;
    }

    .hero-slot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Benefits/Candidate Sections - Grid of images */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    .info-slot {
      aspect-ratio: 4/3;
      border: 2px dashed #e0e0e0;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      background: #fafafa;
    }

    .info-slot:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .info-slot.has-image {
      border-style: solid;
      border-color: #4caf50;
      padding: 0;
    }

    .info-slot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Cases Section - Flexible masonry layout */
    .cases-container {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .case-item {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      border: 2px solid #e0e0e0;
    }

    .case-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .case-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .case-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .case-number-label {
      font-size: 12px;
      color: #999;
      font-family: monospace;
    }

    .case-details {
      margin-bottom: 15px;
    }

    .case-detail-row {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }

    .case-detail-field {
      flex: 1;
    }

    .case-detail-field label,
    .case-description-field label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #666;
      margin-bottom: 6px;
    }

    .case-detail-field input,
    .case-detail-field select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .case-detail-field input:focus,
    .case-detail-field select:focus {
      outline: none;
      border-color: #667eea;
    }

    .case-description-field textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      transition: border-color 0.2s;
    }

    .case-description-field textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .case-actions {
      display: flex;
      gap: 10px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-add {
      background: #667eea;
      color: white;
    }

    .btn-add:hover {
      background: #5568d3;
    }

    .btn-delete-case {
      background: #f44336;
      color: white;
    }

    .btn-delete-case:hover {
      background: #d32f2f;
    }

    .btn-save-desc {
      background: #4caf50;
      color: white;
      margin-top: 8px;
    }

    .btn-save-desc:hover {
      background: #43a047;
    }

    /* Masonry Grid for Case Images */
    .case-images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      grid-auto-flow: dense;
    }

    .case-image-slot {
      border: 2px dashed #ddd;
      border-radius: 10px;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      background: white;
    }

    /* Smart sizing based on image dimensions */
    .case-image-slot.portrait {
      grid-row: span 2;
    }

    .case-image-slot.landscape {
      grid-column: span 2;
    }

    .case-image-slot.large {
      grid-column: span 2;
      grid-row: span 2;
    }

    .case-image-slot:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .case-image-slot.has-image {
      border-style: solid;
      border-color: #4caf50;
      padding: 0;
    }

    .case-image-slot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .slot-placeholder {
      text-align: center;
      padding: 20px;
    }

    .slot-icon {
      font-size: 32px;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    .slot-label {
      font-size: 13px;
      font-weight: 500;
      color: #666;
    }

    .slot-path {
      font-size: 11px;
      color: #999;
      margin-top: 5px;
      font-family: monospace;
    }

    /* Actions overlay */
    .slot-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      display: none;
      gap: 5px;
    }

    .has-image:hover .slot-actions {
      display: flex;
    }

    .action-btn {
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .action-btn:hover {
      background: rgba(0,0,0,0.9);
    }

    /* Upload Modal */
    .upload-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .upload-overlay.active {
      display: flex;
    }

    .upload-modal {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
    }

    .upload-modal h3 {
      margin-bottom: 20px;
      color: #333;
    }

    .upload-area {
      border: 2px dashed #667eea;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-area:hover {
      background: #f8f9ff;
    }

    .upload-area.drag-over {
      background: #e8f0ff;
      border-color: #5568d3;
    }

    .upload-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .upload-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #e0e0e0;
      color: #666;
    }

    .btn-secondary:hover {
      background: #d0d0d0;
    }

    .upload-progress {
      margin-top: 15px;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      overflow: hidden;
      display: none;
    }

    .upload-progress.active {
      display: block;
    }

    .upload-progress-bar {
      height: 100%;
      background: #667eea;
      transition: width 0.3s;
    }

    /* Add new case button */
    .add-case-btn {
      width: 100%;
      padding: 20px;
      border: 2px dashed #667eea;
      border-radius: 12px;
      background: white;
      color: #667eea;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .add-case-btn:hover {
      background: #f8f9ff;
      border-color: #5568d3;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <div class="header-top">
      <div>
        <a href="/admin/procedures-manager.html" class="back-btn">‚Üê Back to Procedures</a>
      </div>
      <div style="text-align: right;">
        <div class="procedure-title" id="procedureName"></div>
        <div class="procedure-path" id="procedurePath"></div>
      </div>
    </div>
  </div>

  <!-- 1. Hero Section -->
  <div class="section">
    <div class="section-title">
      üéØ Hero Banner
    </div>
    <div class="section-description">
      Main banner image for the procedure page. Recommended: 1920x1080px
    </div>
    <div class="hero-slot" data-slot-type="hero" onclick="openUpload('hero', 'hero')">
      <div class="slot-placeholder">
        <div class="slot-icon">üñºÔ∏è</div>
        <div class="slot-label">Click to upload Hero image</div>
        <div class="slot-path">hero.jpg</div>
      </div>
    </div>
  </div>

  <!-- 2. Benefits Section -->
  <div class="section">
    <div class="section-title">
      ‚ú® Benefits of <span id="benefitsTitle"></span>
    </div>
    <div class="section-description">
      Visual representation of procedure benefits. Recommended: 1200x800px
    </div>
    <div class="hero-slot" data-slot-type="benefits" onclick="openUpload('benefits', 'benefits')">
      <div class="slot-placeholder">
        <div class="slot-icon">‚ú®</div>
        <div class="slot-label">Click to upload Benefits image</div>
        <div class="slot-path">benefits.jpg</div>
      </div>
    </div>
  </div>

  <!-- 3. Candidate Section -->
  <div class="section">
    <div class="section-title">
      üë§ You may be a good candidate if...
    </div>
    <div class="section-description">
      Images showing ideal candidates. Recommended: 1200x800px
    </div>
    <div class="hero-slot" data-slot-type="candidate" onclick="openUpload('candidate', 'candidate')">
      <div class="slot-placeholder">
        <div class="slot-icon">üë§</div>
        <div class="slot-label">Click to upload Candidate image</div>
        <div class="slot-path">candidate.jpg</div>
      </div>
    </div>
  </div>

  <!-- 4. Before & After Cases -->
  <div class="section">
    <div class="section-title">
      üì∏ Before & After Cases
      <span style="font-size: 13px; color: #999; font-weight: normal;">(unlimited cases)</span>
    </div>
    <div class="section-description">
      Upload multiple images per case. System will automatically arrange different image sizes intelligently.
    </div>

    <div class="cases-container" id="casesContainer">
      <!-- Cases will be dynamically added here -->
    </div>

    <button class="add-case-btn" onclick="addNewCase()">
      <span style="font-size: 24px;">+</span>
      <span>Add New Case</span>
    </button>
  </div>

  <!-- Upload Modal -->
  <div class="upload-overlay" id="uploadOverlay">
    <div class="upload-modal">
      <h3 id="uploadTitle">Upload Image</h3>
      <div class="upload-area" id="uploadArea">
        <div style="font-size: 48px; margin-bottom: 10px;">üì§</div>
        <div style="font-size: 16px; margin-bottom: 10px;">Drop images here or click to select</div>
        <div style="font-size: 13px; color: #999;">Supported: JPG, PNG, WebP (max 10MB each) - Multiple files supported</div>
        <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
      </div>
      <div class="upload-progress" id="uploadProgress">
        <div class="upload-progress-bar" id="uploadProgressBar"></div>
      </div>
      <div class="upload-buttons">
        <button class="btn-secondary" onclick="closeUpload()">Cancel</button>
        <button class="btn-primary" id="uploadBtn" onclick="startUpload()">Upload</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createSlug } from './procedures-categories.js';
    import { checkAuth, authFetch } from './auth.js';

    // Check authentication
    if (!checkAuth()) {
      throw new Error('Not authenticated');
    }

    let currentProcedureName = '';
    let currentSlug = '';
    let currentSlotType = '';
    let currentSection = ''; // 'hero', 'benefits', 'candidate', 'case'
    let currentCaseId = null;
    let currentImageIndex = null;
    let selectedFiles = []; // Support multiple file selection
    let r2PublicUrl = '';
    let cases = []; // Array to store case data

    // ÂàùÂßãÂåñ
    async function init() {
      const params = new URLSearchParams(window.location.search);
      currentProcedureName = decodeURIComponent(params.get('name') || '');

      if (!currentProcedureName) {
        window.location.href = '/admin/procedures-manager.html';
        return;
      }

      currentSlug = createSlug(currentProcedureName);

      // Êõ¥Êñ∞Ê†áÈ¢ò
      document.getElementById('procedureName').textContent = currentProcedureName;
      document.getElementById('benefitsTitle').textContent = currentProcedureName;
      document.getElementById('procedurePath').textContent = `procedures/${currentSlug}/`;

      // R2 ÂÖ¨ÂºÄ URL ‰ªéÁéØÂ¢ÉÈÖçÁΩÆËé∑ÂèñÔºàÁ°¨ÁºñÁ†ÅÊàñ‰ªéAPIËé∑ÂèñÔºâ
      r2PublicUrl = 'https://pub-364a76a828f94fbeb2b09c625907dcf5.r2.dev';

      // ‰ªé Supabase Âä†ËΩΩ cases
      await loadCasesFromSupabase();

      // Ê∏≤ÊüìÊßΩ‰Ωç
      renderCases();

      // Âä†ËΩΩÂ∑≤ÊúâÂõæÁâá
      await loadExistingImages();
    }

    // ‰ªé Supabase Âä†ËΩΩ cases
    async function loadCasesFromSupabase() {
      try {
        const response = await authFetch(`/api/admin/cases?slug=${encodeURIComponent(currentSlug)}`);
        const data = await response.json();

        if (data.success && data.cases && data.cases.length > 0) {
          cases = data.cases.map((c, idx) => ({
            id: idx + 1,
            caseNumber: c.case_number,
            description: c.description || '',
            providerName: c.provider_name || 'Dr. Heather Lee',
            patientAge: c.patient_age || '',
            patientGender: c.patient_gender || '',
            imageCount: c.image_count || 2,
            images: []
          }));
          console.log('Loaded cases from Supabase:', cases);
        }
      } catch (error) {
        console.error('Error loading cases from Supabase:', error);
      }
    }

    // ‰øùÂ≠ò case Âà∞ Supabase
    async function saveCaseToSupabase(caseItem) {
      try {
        const response = await authFetch('/api/admin/cases', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            slug: currentSlug,
            case_number: caseItem.caseNumber,
            description: caseItem.description || '',
            provider_name: caseItem.providerName || 'Dr. Heather Lee',
            patient_age: caseItem.patientAge || null,
            patient_gender: caseItem.patientGender || null,
            image_count: caseItem.images ? caseItem.images.length : 0,
            sort_order: caseItem.id - 1
          })
        });

        const data = await response.json();
        if (data.success) {
          console.log('Case saved to Supabase:', data.case);
        } else {
          console.error('Failed to save case:', data.message);
        }
      } catch (error) {
        console.error('Error saving case to Supabase:', error);
      }
    }

    // Ê∏≤ÊüìÊ°à‰æã
    function renderCases() {
      const container = document.getElementById('casesContainer');

      if (cases.length === 0) {
        // Ê∑ªÂä†Á¨¨‰∏Ä‰∏™ÈªòËÆ§Ê°à‰æãÔºåÁîüÊàê6‰ΩçÈöèÊú∫ case number
        cases.push({ id: 1, caseNumber: generateCaseNumber(), description: '', patientAge: '', patientGender: '', images: [] });
      }

      let html = '';
      cases.forEach(caseItem => {
        html += `
          <div class="case-item" data-case-id="${caseItem.id}">
            <div class="case-header">
              <div class="case-info">
                <div class="case-title">Case #${caseItem.caseNumber || generateCaseNumber()}</div>
                <div class="case-number-label">ID: ${caseItem.caseNumber || 'N/A'}</div>
              </div>
              <div class="case-actions">
                <button type="button" class="btn-small btn-add" onclick="openUpload('case', ${caseItem.id})">
                  + Add Image
                </button>
                ${cases.length > 1 ? `
                  <button type="button" class="btn-small btn-delete-case" onclick="deleteCase(${caseItem.id})">
                    Delete Case
                  </button>
                ` : ''}
              </div>
            </div>
            <div class="case-details">
              <div class="case-detail-row">
                <div class="case-detail-field">
                  <label>Patient Age:</label>
                  <input
                    type="text"
                    id="case-age-${caseItem.id}"
                    placeholder="e.g., 35"
                    value="${caseItem.patientAge || ''}"
                  >
                </div>
                <div class="case-detail-field">
                  <label>Patient Gender:</label>
                  <select id="case-gender-${caseItem.id}">
                    <option value="" ${!caseItem.patientGender ? 'selected' : ''}>Select...</option>
                    <option value="Female" ${caseItem.patientGender === 'Female' ? 'selected' : ''}>Female</option>
                    <option value="Male" ${caseItem.patientGender === 'Male' ? 'selected' : ''}>Male</option>
                  </select>
                </div>
              </div>
              <div class="case-description-field">
                <label>Description:</label>
                <textarea
                  id="case-desc-${caseItem.id}"
                  placeholder="Enter case description (e.g., procedure details, recovery notes...)"
                >${caseItem.description || ''}</textarea>
              </div>
              <button type="button" class="btn-small btn-save-desc" onclick="saveCaseDetails(${caseItem.id})">
                Save Case Details
              </button>
            </div>
            <div class="case-images-grid" id="case-${caseItem.id}-grid">
              ${renderCaseImages(caseItem)}
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // Ê∏≤ÊüìÂçï‰∏™Ê°à‰æãÁöÑÂõæÁâá
    function renderCaseImages(caseItem) {
      if (!caseItem.images || caseItem.images.length === 0) {
        return `
          <div class="case-image-slot" onclick="openUpload('case', ${caseItem.id}, 1)">
            <div class="slot-placeholder">
              <div class="slot-icon">üì∑</div>
              <div class="slot-label">Add first image</div>
            </div>
          </div>
        `;
      }

      let html = '';
      const cacheBuster = `?t=${Date.now()}`;
      caseItem.images.forEach((img, idx) => {
        const sizeClass = getSizeClass(img.width, img.height);
        const displayUrl = img.url + cacheBuster;
        html += `
          <div class="case-image-slot has-image ${sizeClass}" data-image-index="${idx}">
            <img src="${displayUrl}" alt="Case ${caseItem.id} - Image ${idx + 1}">
            <div class="slot-actions">
              <button class="action-btn" onclick="event.stopPropagation(); viewImage('${img.url}')" title="View">üëÅÔ∏è</button>
              <button class="action-btn" onclick="event.stopPropagation(); deleteCaseImage(${caseItem.id}, ${idx})" title="Delete">üóëÔ∏è</button>
            </div>
          </div>
        `;
      });

      // Ê∑ªÂä†‰∏Ä‰∏™Á©∫ÊßΩ‰ΩçÁî®‰∫éÊ∑ªÂä†Êõ¥Â§öÂõæÁâá
      html += `
        <div class="case-image-slot" onclick="openUpload('case', ${caseItem.id}, ${caseItem.images.length + 1})">
          <div class="slot-placeholder">
            <div class="slot-icon">+</div>
            <div class="slot-label">Add more</div>
          </div>
        </div>
      `;

      return html;
    }

    // Êô∫ËÉΩÂà§Êñ≠ÂõæÁâáÂ∞∫ÂØ∏Á±ªÂà´
    function getSizeClass(width, height) {
      if (!width || !height) return '';

      const ratio = width / height;

      if (ratio > 1.5) return 'landscape'; // Ê®™Âêë
      if (ratio < 0.7) return 'portrait';  // Á´ñÂêë
      if (width > 1000 && height > 1000) return 'large'; // Â§ßÂõæ
      return '';
    }

    // ÁîüÊàê6‰ΩçÈöèÊú∫ case number
    function generateCaseNumber() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // Êõ¥Êñ∞Ê°à‰æãÊèèËø∞ÔºàËá™Âä®‰øùÂ≠òÂà∞ SupabaseÔºâ
    window.updateCaseDescription = async function(caseId, description) {
      const caseItem = cases.find(c => c.id === caseId);
      if (caseItem) {
        caseItem.description = description;
        // ‰øùÂ≠òÂà∞ Supabase
        await saveCaseToSupabase(caseItem);
        console.log(`Case ${caseId} description saved:`, description);
      }
    };

    // ‰øùÂ≠òÊ°à‰æãËØ¶ÊÉÖÔºàÈÄöËøáÊåâÈíÆÁÇπÂáªÔºâ
    window.saveCaseDetails = async function(caseId) {
      const textarea = document.getElementById(`case-desc-${caseId}`);
      const ageInput = document.getElementById(`case-age-${caseId}`);
      const genderSelect = document.getElementById(`case-gender-${caseId}`);

      if (!textarea) {
        alert('Error: Cannot find description field');
        return;
      }

      const caseItem = cases.find(c => c.id === caseId);
      if (caseItem) {
        caseItem.description = textarea.value;
        caseItem.patientAge = ageInput ? ageInput.value : '';
        caseItem.patientGender = genderSelect ? genderSelect.value : '';

        // ‰øùÂ≠òÂà∞ Supabase
        await saveCaseToSupabase(caseItem);
        alert('Case details saved successfully!');
        console.log(`Case ${caseId} details saved:`, {
          description: caseItem.description,
          patientAge: caseItem.patientAge,
          patientGender: caseItem.patientGender
        });
      } else {
        alert('Error: Case not found');
      }
    };

    // ‰øùÁïôÊóßÂáΩÊï∞Âêç‰ª•ÂÖºÂÆπÔºàÂèØÈÄâÔºâ
    window.saveCaseDescription = window.saveCaseDetails;

    // Ê∑ªÂä†Êñ∞Ê°à‰æãÔºàËá™Âä®‰øùÂ≠òÂà∞ SupabaseÔºâ
    window.addNewCase = async function() {
      const newId = Math.max(...cases.map(c => c.id), 0) + 1;
      const newCase = {
        id: newId,
        caseNumber: generateCaseNumber(),
        description: '',
        patientAge: '',
        patientGender: '',
        images: []
      };
      cases.push(newCase);
      renderCases();
      // ‰øùÂ≠òÂà∞ Supabase
      await saveCaseToSupabase(newCase);
    };

    // Âà†Èô§Ê°à‰æã
    window.deleteCase = async function(caseId) {
      if (!confirm('Are you sure you want to delete this entire case and all its images?')) return;

      const caseItem = cases.find(c => c.id === caseId);
      if (!caseItem) {
        alert('Case not found');
        return;
      }

      try {
        console.log('Deleting case:', caseItem.caseNumber, 'from slug:', currentSlug);

        // 1. ÂÖàÂà†Èô§ R2 ‰∏≠ÁöÑÊâÄÊúâÂõæÁâá
        if (caseItem.images && caseItem.images.length > 0) {
          console.log('Deleting', caseItem.images.length, 'images from R2');
          for (const image of caseItem.images) {
            if (image && image.key) {
              try {
                await authFetch(`/api/admin/delete?key=${encodeURIComponent(image.key)}`, {
                  method: 'DELETE'
                });
                console.log('Deleted image:', image.key);
              } catch (imgError) {
                console.error('Error deleting image:', image.key, imgError);
              }
            }
          }
        }

        // 2. ‰ªé Supabase Âà†Èô§ case ËÆ∞ÂΩï
        const response = await authFetch(`/api/admin/cases?slug=${encodeURIComponent(currentSlug)}&case_number=${encodeURIComponent(caseItem.caseNumber)}`, {
          method: 'DELETE'
        });

        const data = await response.json();
        console.log('Delete response:', data);

        if (!data.success) {
          alert('Failed to delete case from database: ' + (data.message || 'Unknown error'));
          return;
        }

        // 3. Âà†Èô§ÊàêÂäüÂêé‰ªéÂâçÁ´ØÁßªÈô§
        cases = cases.filter(c => c.id !== caseId);
        renderCases();
        alert('Case and all images deleted successfully');
      } catch (error) {
        console.error('Error deleting case:', error);
        alert('Error deleting case: ' + error.message);
      }
    };

    // Âà†Èô§Ê°à‰æã‰∏≠ÁöÑÊüêÂº†ÂõæÁâá
    window.deleteCaseImage = async function(caseId, imageIndex) {
      if (!confirm('Are you sure you want to delete this image?')) return;

      const caseItem = cases.find(c => c.id === caseId);
      if (!caseItem) return;

      const image = caseItem.images[imageIndex];

      try {
        // ‰ªé R2 Âà†Èô§
        const response = await authFetch(`/api/admin/delete?key=${encodeURIComponent(image.key)}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          caseItem.images.splice(imageIndex, 1);
          renderCases();
          alert('Image deleted successfully');
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('Delete failed: ' + error.message);
      }
    };

    // Âä†ËΩΩÂ∑≤Â≠òÂú®ÁöÑÂõæÁâá
    async function loadExistingImages() {
      try {
        const prefix = `procedures/${currentSlug}/`;
        const response = await authFetch(`/api/admin/images?prefix=${encodeURIComponent(prefix)}`);
        const data = await response.json();

        if (data.success && data.images) {
          data.images.forEach(img => {
            const parts = img.key.split('/');
            const filename = parts[parts.length - 1];
            const [type, ...rest] = filename.replace('.jpg', '').split('-');

            if (type === 'hero' || type === 'benefits' || type === 'candidate') {
              updateSlotWithImage(type, img.url);
            } else if (type === 'case') {
              // Êñá‰ª∂ÂêçÊ†ºÂºè: case-{caseNumber}-{imageIndex}.jpg
              // ‰æãÂ¶Ç: case-333064-1.jpg, case-333064-2.jpg
              const caseNumber = rest[0]; // caseNumber ÊòØÂ≠óÁ¨¶‰∏≤
              const imgIndex = parseInt(rest[1]) - 1;

              // Áî® caseNumber ÂåπÈÖç case
              let caseItem = cases.find(c => c.caseNumber === caseNumber);
              if (!caseItem) {
                // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂåπÈÖçÁöÑ caseÔºåÂèØËÉΩÊòØÊóßÊ†ºÂºèÊñá‰ª∂ÔºåÂ∞ùËØïÁî®Êï∞Â≠ó id ÂåπÈÖç
                const numericId = parseInt(caseNumber);
                caseItem = cases.find(c => c.id === numericId);

                // Â¶ÇÊûúËøòÊâæ‰∏çÂà∞ÔºåÂàõÂª∫Êñ∞ÁöÑ caseÔºàÁî®‰∫éÂ§ÑÁêÜÂ≠§Á´ãÂõæÁâáÔºâ
                if (!caseItem) {
                  console.log('Creating orphan case for image:', filename);
                  const newId = cases.length > 0 ? Math.max(...cases.map(c => c.id)) + 1 : 1;
                  caseItem = {
                    id: newId,
                    caseNumber: caseNumber,
                    description: '',
                    providerName: 'Dr. Heather Lee',
                    patientAge: '',
                    patientGender: '',
                    images: []
                  };
                  cases.push(caseItem);
                }
              }

              caseItem.images[imgIndex] = {
                url: img.url,
                key: img.key,
                width: 800,
                height: 600
              };
            }
          });

          renderCases();
        }
      } catch (error) {
        console.error('Error loading images:', error);
      }
    }

    // Êõ¥Êñ∞ÊßΩ‰ΩçÊòæÁ§∫ÂõæÁâáÔºàÊ∑ªÂä†Êó∂Èó¥Êà≥Á†¥ÂùèÁºìÂ≠òÔºâ
    function updateSlotWithImage(slotId, imageUrl) {
      const slot = document.querySelector(`[data-slot-id="${slotId}"], [data-slot-type="${slotId}"]`);
      if (!slot) return;

      // Ê∑ªÂä†Êó∂Èó¥Êà≥Á†¥ÂùèÊµèËßàÂô®ÁºìÂ≠ò
      const cacheBuster = `?t=${Date.now()}`;
      const displayUrl = imageUrl + cacheBuster;

      slot.classList.add('has-image');
      slot.innerHTML = `
        <img src="${displayUrl}" alt="${slotId}">
        <div class="slot-actions">
          <button class="action-btn" onclick="event.stopPropagation(); viewImage('${imageUrl}')" title="View">üëÅÔ∏è</button>
          <button class="action-btn" onclick="event.stopPropagation(); deleteImage('${slotId}')" title="Delete">üóëÔ∏è</button>
        </div>
      `;
    }

    // ÊâìÂºÄ‰∏ä‰º†ÂºπÁ™ó
    window.openUpload = function(section, idOrIndex, imageIndex = null) {
      currentSection = section;

      if (section === 'hero' || section === 'benefits' || section === 'candidate') {
        currentSlotType = section;
        currentImageIndex = null;
        const titles = {
          hero: 'Hero Image',
          benefits: 'Benefits Image',
          candidate: 'Candidate Image'
        };
        document.getElementById('uploadTitle').textContent = `Upload ${titles[section]}`;
      } else if (section === 'case') {
        currentCaseId = idOrIndex;
        currentImageIndex = imageIndex;
        document.getElementById('uploadTitle').textContent = `Upload Case ${idOrIndex} Image`;
      }

      document.getElementById('uploadOverlay').classList.add('active');
      selectedFiles = [];
      document.getElementById('uploadBtn').disabled = false;
    };

    // ÂÖ≥Èó≠‰∏ä‰º†ÂºπÁ™ó
    window.closeUpload = function() {
      document.getElementById('uploadOverlay').classList.remove('active');
      selectedFiles = [];
      document.getElementById('fileInput').value = '';
      document.getElementById('uploadProgress').classList.remove('active');
    };

    // Êñá‰ª∂ÈÄâÊã©
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    uploadArea.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        selectedFiles = Array.from(e.target.files);
        const fileCount = selectedFiles.length;
        if (fileCount === 1) {
          uploadArea.querySelector('div:nth-child(2)').textContent = `Selected: ${selectedFiles[0].name}`;
        } else {
          uploadArea.querySelector('div:nth-child(2)').textContent = `Selected: ${fileCount} images`;
        }
      }
    });

    // ÊãñÊãΩ‰∏ä‰º†
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('drag-over');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('drag-over');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('drag-over');
      if (e.dataTransfer.files.length > 0) {
        selectedFiles = Array.from(e.dataTransfer.files);
        fileInput.files = e.dataTransfer.files;
        const fileCount = selectedFiles.length;
        if (fileCount === 1) {
          uploadArea.querySelector('div:nth-child(2)').textContent = `Selected: ${selectedFiles[0].name}`;
        } else {
          uploadArea.querySelector('div:nth-child(2)').textContent = `Selected: ${fileCount} images`;
        }
      }
    });

    // ÂºÄÂßã‰∏ä‰º†ÔºàÊîØÊåÅÂ§öÊñá‰ª∂Ôºâ
    window.startUpload = async function() {
      if (!selectedFiles || selectedFiles.length === 0) {
        alert('Please select at least one file');
        return;
      }

      const remotePath = `procedures/${currentSlug}`;

      try {
        document.getElementById('uploadProgress').classList.add('active');
        document.getElementById('uploadBtn').disabled = true;

        let successCount = 0;
        let failCount = 0;

        // ÂØπ‰∫é case ‰∏ä‰º†ÔºåÈúÄË¶ÅËé∑ÂèñÊàñÂàõÂª∫ caseItem
        let caseItem = null;
        let caseNumber = null;
        if (currentSection === 'case') {
          caseItem = cases.find(c => c.id === currentCaseId);
          if (!caseItem) {
            caseNumber = generateCaseNumber();
            caseItem = { id: currentCaseId, caseNumber: caseNumber, description: '', images: [] };
            cases.push(caseItem);
          } else {
            caseNumber = caseItem.caseNumber;
          }
        }

        // ÈÄê‰∏™‰∏ä‰º†Êñá‰ª∂
        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          let filename;

          if (currentSection === 'case') {
            const imageCount = caseItem.images.length;
            filename = `case-${caseNumber}-${imageCount + 1}.jpg`;
          } else {
            // Èùû case ‰∏ä‰º†Âè™ÊîØÊåÅÂçïÊñá‰ª∂
            filename = `${currentSlotType}.jpg`;
          }

          const formData = new FormData();
          formData.append('file', file);
          formData.append('path', remotePath);
          formData.append('filename', filename);

          try {
            const response = await authFetch('/api/admin/upload', {
              method: 'POST',
              body: formData
            });

            const data = await response.json();

            if (data.success) {
              successCount++;

              if (currentSection === 'case') {
                // Ëé∑ÂèñÂõæÁâáÂ∞∫ÂØ∏Âπ∂Ê∑ªÂä†Âà∞ case
                await new Promise((resolve) => {
                  const img = new Image();
                  img.onload = function() {
                    caseItem.images.push({
                      url: data.url,
                      key: data.key,
                      width: img.width,
                      height: img.height
                    });
                    resolve();
                  };
                  img.onerror = function() {
                    // Âç≥‰ΩøËé∑ÂèñÂ∞∫ÂØ∏Â§±Ë¥•‰πüÊ∑ªÂä†ÂõæÁâá
                    caseItem.images.push({
                      url: data.url,
                      key: data.key,
                      width: 0,
                      height: 0
                    });
                    resolve();
                  };
                  img.src = data.url;
                });
              } else {
                updateSlotWithImage(currentSlotType, data.url);
              }
            } else {
              failCount++;
              console.error(`Upload failed for ${file.name}:`, data.message);
            }
          } catch (error) {
            failCount++;
            console.error(`Upload error for ${file.name}:`, error);
          }
        }

        // Â¶ÇÊûúÊòØ caseÔºå‰øùÂ≠òÂà∞ Supabase
        if (currentSection === 'case' && caseItem) {
          renderCases();
          await saveCaseToSupabase(caseItem);
          console.log('Case saved to Supabase after image upload:', caseItem.caseNumber);
        }

        closeUpload();

        if (failCount === 0) {
          alert(`Upload successful! ${successCount} image(s) uploaded.`);
        } else {
          alert(`Upload completed: ${successCount} succeeded, ${failCount} failed.`);
        }
      } catch (error) {
        console.error('Upload error:', error);
        alert('Upload failed: ' + error.message);
      } finally {
        document.getElementById('uploadProgress').classList.remove('active');
        document.getElementById('uploadBtn').disabled = false;
      }
    };

    // Êü•ÁúãÂõæÁâá
    window.viewImage = function(url) {
      window.open(url, '_blank');
    };

    // Âà†Èô§ÂõæÁâá
    window.deleteImage = async function(slotId) {
      if (!confirm('Are you sure you want to delete this image?')) return;

      const key = `procedures/${currentSlug}/${slotId}.jpg`;

      try {
        const response = await authFetch(`/api/admin/delete?key=${encodeURIComponent(key)}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          const slot = document.querySelector(`[data-slot-id="${slotId}"], [data-slot-type="${slotId}"]`);
          if (slot) {
            slot.classList.remove('has-image');
            const isHero = slotId === 'hero';
            slot.innerHTML = `
              <div class="slot-placeholder">
                <div class="slot-icon">üñºÔ∏è</div>
                <div class="slot-label">Click to upload ${slotId}</div>
                <div class="slot-path">${slotId}.jpg</div>
              </div>
            `;
          }
          alert('Image deleted successfully');
        } else {
          alert('Delete failed: ' + data.message);
        }
      } catch (error) {
        console.error('Delete error:', error);
        alert('Delete failed: ' + error.message);
      }
    };

    // ÂêØÂä®
    init();
  </script>

</body>
</html>
